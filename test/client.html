<!DOCTYPE html>
<html lang="ja">
<head>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Remote Desktop Client</title>
</head>
<body>
	<h1>Remote Desktop Client</h1>
	<video id="remoteVideo" autoplay playsinline controls style="width:80vw; height:60vh; background:#000;"></video>
	<script>
	const ws = new WebSocket('ws://' + location.hostname + ':8765');
	const pc = new RTCPeerConnection();
	const video = document.getElementById('remoteVideo');

	// 受信専用のトランシーバーを追加（SDPエラー防止）
	pc.addTransceiver('video', { direction: 'recvonly' });
	// 音声も必要なら下記を有効化
	// pc.addTransceiver('audio', { direction: 'recvonly' });

	// シグナリング: offer送信
	ws.onopen = async () => {
		const offer = await pc.createOffer();
		await pc.setLocalDescription(offer);
		ws.send(JSON.stringify({sdp: offer.sdp, type: offer.type}));
	};

	// シグナリング: answer/ICE candidate受信
	ws.onmessage = async (event) => {
		const msg = JSON.parse(event.data);
		if (msg.type === 'answer') {
			await pc.setRemoteDescription(new RTCSessionDescription(msg));
		} else if (msg.type === 'candidate' && msg.candidate) {
			await pc.addIceCandidate(msg.candidate);
		}
	};

	// ICE candidate送信
	pc.onicecandidate = (event) => {
		if (event.candidate) {
			ws.send(JSON.stringify({type: 'candidate', candidate: event.candidate}));
		}
	};

	// 映像トラック受信
	pc.ontrack = (event) => {
		if (event.track.kind === 'video') {
			video.srcObject = event.streams[0];
		}
	};

	// 受信専用のトラックを追加
	pc.addTransceiver('video', { direction: 'recvonly' });
	// 音声も必要なら
	//pc.addTransceiver('audio', { direction: 'recvonly' });
	</script>
</body>
</html>
