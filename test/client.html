<!DOCTYPE html>
<html lang="ja">
<head>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Remote Desktop Client</title>
</head>
<body style="margin:0; background:#000; height:100vh; width:100vw; overflow:hidden;">
	<div style="display:flex; flex-direction:column; height:100vh; width:100vw;">
		<!-- 上黒帯 -->
		<div style="flex:0 0 5vh; background:#000;"></div>
		<!-- メインコンテンツ -->
		<div style="flex:1; display:flex; flex-direction:row; align-items:center; justify-content:space-between; background:#000; width:100vw;">
			<!-- 左ボタン -->
			<button id="leftBtn" style="flex:0 0 6vw; height:70%; margin-left:1vw; font-size:2vw;">◀</button>
			<!-- ビデオ -->
			<div style="flex:1; display:flex; align-items:center; justify-content:center;">
				<video id="remoteVideo" autoplay playsinline controls 
					style="width:100%; max-width:100vw; max-height:80vh; aspect-ratio:16/9; background:#000; border-radius:1vw; box-shadow:0 0 20px #222;"></video>
			</div>
			<!-- 右ボタン -->
			<button id="rightBtn" style="flex:0 0 6vw; height:70%; margin-right:1vw; font-size:2vw;">▶</button>
		</div>
		<!-- 下黒帯 -->
		<div style="flex:0 0 5vh; background:#000;"></div>
	</div>
	<script>
		const ws = new WebSocket('ws://' + location.hostname + ':8765');
		const pc = new RTCPeerConnection();
		const video = document.getElementById('remoteVideo');

		// 受信専用のトランシーバーを追加（SDPエラー防止）
		pc.addTransceiver('video', { direction: 'recvonly' });
		pc.addTransceiver('audio', { direction: 'recvonly' });

		// シグナリング: offer送信
		ws.onopen = async () => {
			const offer = await pc.createOffer();
			await pc.setLocalDescription(offer);
			ws.send(JSON.stringify({sdp: offer.sdp, type: offer.type}));
		};

		// シグナリング: answer/ICE candidate受信
		ws.onmessage = async (event) => {
			const msg = JSON.parse(event.data);
			if (msg.type === 'answer') {
				await pc.setRemoteDescription(new RTCSessionDescription(msg));
			} else if (msg.type === 'candidate' && msg.candidate) {
				await pc.addIceCandidate(msg.candidate);
			}
		};

		// ICE candidate送信
		pc.onicecandidate = (event) => {
			if (event.candidate) {
				ws.send(JSON.stringify({type: 'candidate', candidate: event.candidate}));
			}
		};

		// トラック受信（映像・音声）
		pc.ontrack = (event) => {
			// 最初のstreamにvideo/audio両方入るので一度だけsrcObjectをセット
			if (video.srcObject !== event.streams[0]) {
				video.srcObject = event.streams[0];
			}
		};

		// 受信専用のトラックを追加（冗長なため削除）
	</script>
</body>
</html>
